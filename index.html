<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YesNo â€” ì˜ˆ, í˜¹ì€ ì•„ë‹ˆì˜¤. ì§„ì‹¤ì„ ì°¾ì•„ë¼.</title>
<meta name="description" content="AIê°€ ì¶œì œí•˜ëŠ” ë°”ë‹¤ê±°ë¶ ìˆ˜í”„ ì¶”ë¦¬ ê²Œì„. ì˜ˆì™€ ì•„ë‹ˆì˜¤, ê·¸ê²ƒë§Œìœ¼ë¡œ ë¯¸ìŠ¤í„°ë¦¬ë¥¼ í’€ì–´ë¼.">
<meta property="og:title" content="YesNo â€” ë°”ë‹¤ê±°ë¶ ìˆ˜í”„ ì¶”ë¦¬ ê²Œì„">
<meta property="og:description" content="ì˜ˆ, í˜¹ì€ ì•„ë‹ˆì˜¤. ê·¸ê²ƒë§Œìœ¼ë¡œ ì§„ì‹¤ì„ ì°¾ì•„ë¼.">
<meta property="og:type" content="website">
<meta property="og:url" content="https://yesno.salmonholic.com">
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9910139662531641" crossorigin="anonymous"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-HWMPYGPHV6"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-HWMPYGPHV6');
</script>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”®</text></svg>">
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg:#0a0a0a;--bg2:#111;--bg3:#1a1a1a;
  --text:#e0e0e0;--text2:#888;--text3:#555;
  --accent:#00ff88;--accent2:#00cc6a;--accent-glow:rgba(0,255,136,.15);
  --danger:#ff4444;--warn:#ffaa00;
  --card:rgba(255,255,255,.03);--card-border:rgba(255,255,255,.06);
  --glass:rgba(255,255,255,.05);
}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;line-height:1.6;overflow-x:hidden}
a{color:var(--accent);text-decoration:none}

/* Hero */
.hero{min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;position:relative;overflow:hidden;padding:2rem}
.hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 50%,rgba(0,255,136,.04) 0%,transparent 70%);pointer-events:none}
.hero h1{font-size:clamp(2.5rem,8vw,5rem);font-weight:800;letter-spacing:-0.03em;margin-bottom:1rem;background:linear-gradient(135deg,#fff 0%,#00ff88 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.hero p{font-size:clamp(1rem,3vw,1.4rem);color:var(--text2);max-width:500px;margin-bottom:2.5rem}
.hero-cta{padding:16px 48px;background:var(--accent);color:#000;font-size:1.1rem;font-weight:700;border:none;border-radius:50px;cursor:pointer;transition:all .3s;letter-spacing:.02em}
.hero-cta:hover{background:#fff;transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,255,136,.3)}
.scroll-hint{position:absolute;bottom:2rem;animation:bounce 2s infinite;color:var(--text3);font-size:1.5rem}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(10px)}}

/* Particles */
.particles{position:absolute;inset:0;pointer-events:none;overflow:hidden}
.particle{position:absolute;width:4px;height:4px;background:var(--accent);border-radius:50%;opacity:.5;box-shadow:0 0 6px var(--accent);animation:float linear infinite}
@keyframes float{0%{transform:translateY(100vh) scale(0);opacity:0}10%{opacity:.5}90%{opacity:.5}100%{transform:translateY(-10vh) scale(1);opacity:0}}

/* Stories Section */
.stories-section{max-width:800px;margin:0 auto;padding:2rem 1.5rem 4rem}
.stories-section h2{font-size:1.8rem;margin-bottom:.5rem}
.stories-section .subtitle{color:var(--text2);margin-bottom:2rem}
.story-list{display:flex;flex-direction:column;gap:1rem}

/* Story Card */
.story-card{background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:1.5rem;backdrop-filter:blur(10px);transition:all .3s;cursor:default;position:relative;overflow:hidden}
.story-card:hover{border-color:rgba(0,255,136,.2);background:rgba(255,255,255,.05);transform:translateY(-2px)}
.story-card.cleared{opacity:.4;pointer-events:none}
.story-card.locked{opacity:.3;pointer-events:none;filter:blur(1px)}
.story-card.cleared::after{content:'âœ“ í´ë¦¬ì–´';position:absolute;top:1rem;right:1rem;background:var(--accent2);color:#000;padding:4px 12px;border-radius:20px;font-size:.8rem;font-weight:700}
.card-header{display:flex;align-items:center;gap:12px;margin-bottom:.8rem}
.card-emoji{font-size:2rem}
.card-title{font-size:1.2rem;font-weight:700}
.card-diff{display:flex;gap:2px;margin-left:auto}
.card-diff .star{color:var(--accent);font-size:.9rem}
.card-diff .star.empty{color:var(--text3)}
.card-situation{color:var(--text2);font-size:.95rem;margin-bottom:1.2rem;line-height:1.7}
.card-start{padding:10px 28px;background:transparent;border:1px solid var(--accent);color:var(--accent);border-radius:50px;cursor:pointer;font-size:.9rem;font-weight:600;transition:all .3s;float:right}
.card-start:hover{background:var(--accent);color:#000}

/* Game Screen */
.game-screen{display:none;max-width:700px;margin:0 auto;min-height:100vh;padding:1rem;flex-direction:column}
.game-screen.active{display:flex}
.game-header{display:flex;align-items:center;padding:1rem 0;border-bottom:1px solid var(--card-border);margin-bottom:1rem;gap:12px}
.game-back{background:none;border:none;color:var(--text2);font-size:1.3rem;cursor:pointer;padding:4px 8px}
.game-back:hover{color:var(--text)}
.game-title{font-size:1.1rem;font-weight:700}
.game-turns{margin-left:auto;color:var(--text2);font-size:.85rem}

.chat-area{flex:1;overflow-y:auto;padding:1rem 0;display:flex;flex-direction:column;gap:.8rem}
.chat-msg{max-width:85%;padding:12px 16px;border-radius:16px;font-size:.95rem;line-height:1.6;animation:msgIn .3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.chat-msg.ai{background:var(--bg3);border:1px solid var(--card-border);align-self:flex-start;border-bottom-left-radius:4px}
.chat-msg.ai .label{color:var(--accent);font-size:.8rem;font-weight:700;margin-bottom:4px}
.chat-msg.user{background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.2);align-self:flex-end;border-bottom-right-radius:4px}
.chat-msg.system{align-self:center;background:rgba(255,170,0,.1);border:1px solid rgba(255,170,0,.2);color:var(--warn);font-size:.85rem;text-align:center}
.chat-msg.correct{align-self:center;background:rgba(0,255,136,.1);border:1px solid rgba(0,255,136,.3);text-align:center}
.chat-msg.correct h3{color:var(--accent);margin-bottom:8px}

.input-area{padding:1rem 0;border-top:1px solid var(--card-border);display:flex;gap:8px;align-items:center}
.input-area input{flex:1;padding:12px 16px;background:var(--bg3);border:1px solid var(--card-border);border-radius:50px;color:var(--text);font-size:.95rem;outline:none;transition:border-color .3s}
.input-area input:focus{border-color:var(--accent)}
.input-area input::placeholder{color:var(--text3)}
.btn-ask{padding:12px 20px;background:var(--accent);color:#000;border:none;border-radius:50px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-ask:hover{background:#fff}
.btn-ask:disabled{opacity:.3;cursor:not-allowed}
.btn-solve{padding:12px 20px;background:transparent;border:1px solid var(--warn);color:var(--warn);border-radius:50px;font-weight:700;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-solve:hover{background:var(--warn);color:#000}
.btn-hint{padding:12px 16px;background:transparent;border:1px solid #aa66ff;color:#aa66ff;border-radius:50px;font-weight:600;cursor:pointer;font-size:.8rem;transition:all .2s;white-space:nowrap}
.btn-hint:hover{background:#aa66ff;color:#fff}
.btn-hint:disabled{opacity:.3;cursor:not-allowed;border-color:var(--text3);color:var(--text3)}
.btn-giveup{padding:12px 16px;background:transparent;border:1px solid var(--danger);color:var(--danger);border-radius:50px;font-weight:600;cursor:pointer;font-size:.8rem;transition:all .2s;white-space:nowrap}
.btn-giveup:hover{background:var(--danger);color:#fff}

/* Stats Section */
.stats-section{max-width:800px;margin:0 auto;padding:0 1.5rem 4rem}
.stats-card{background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:2rem;backdrop-filter:blur(10px)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1.5rem;margin-bottom:1.5rem}
.stat-box{text-align:center}
.stat-box .stat-num{font-size:2rem;font-weight:800;color:var(--accent)}
.stat-box .stat-desc{font-size:.85rem;color:var(--text2);margin-top:4px}
.grade-badge{display:inline-block;font-size:3rem;font-weight:800;margin-bottom:.5rem}
.grade-title{font-size:1.1rem;color:var(--text2)}

/* Solve Modal */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;align-items:center;justify-content:center;padding:1rem}
.modal-overlay.active{display:flex}
.modal{background:var(--bg2);border:1px solid var(--card-border);border-radius:20px;padding:2rem;max-width:500px;width:100%}
.modal h3{margin-bottom:1rem;font-size:1.2rem}
.modal textarea{width:100%;height:120px;background:var(--bg3);border:1px solid var(--card-border);border-radius:12px;color:var(--text);padding:12px;font-size:.95rem;resize:none;outline:none;font-family:inherit}
.modal textarea:focus{border-color:var(--accent)}
.modal-btns{display:flex;gap:8px;margin-top:1rem;justify-content:flex-end}
.modal-btns button{padding:10px 24px;border-radius:50px;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.modal-cancel{background:var(--bg3);color:var(--text)}
.modal-submit{background:var(--warn);color:#000}

/* Result Screen */
.result-screen{display:none;max-width:600px;margin:0 auto;padding:2rem;text-align:center;min-height:100vh;flex-direction:column;align-items:center;justify-content:center}
.result-screen.active{display:flex}
.result-screen h2{font-size:2rem;margin-bottom:.5rem}
.result-screen .result-emoji{font-size:4rem;margin-bottom:1rem}
.result-stats{background:var(--card);border:1px solid var(--card-border);border-radius:16px;padding:1.5rem;width:100%;margin:1.5rem 0;text-align:left}
.result-stats .stat-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--card-border)}
.result-stats .stat-row:last-child{border:none}
.result-stats .stat-label{color:var(--text2)}
.result-stats .stat-value{font-weight:700}
.result-answer{background:rgba(0,255,136,.05);border:1px solid rgba(0,255,136,.15);border-radius:16px;padding:1.5rem;width:100%;margin-bottom:1.5rem;text-align:left}
.result-answer h4{color:var(--accent);margin-bottom:8px}
.result-answer p{color:var(--text2);line-height:1.7}
.result-btns{display:flex;gap:12px}
.result-btns button{padding:14px 32px;border-radius:50px;font-weight:700;cursor:pointer;border:none;font-size:1rem;transition:all .2s}
.btn-home{background:var(--bg3);color:var(--text)}
.btn-home:hover{background:var(--card-border)}
.btn-share{background:var(--accent);color:#000}
.btn-share:hover{background:#fff}

/* Loading */
.loading{display:inline-block;width:20px;height:20px;border:2px solid var(--text3);border-top-color:var(--accent);border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-left:8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Responsive */
@media(max-width:600px){
  .hero h1{font-size:2.5rem}
  .stories-section{padding:1.5rem 1rem 3rem}
  .card-start{float:none;width:100%;margin-top:.5rem}
  .input-area{flex-wrap:wrap}
  .input-area input{min-width:0}
  .btn-giveup{font-size:.75rem;padding:10px 12px}
}
</style>
</head>
<body>

<!-- HOME -->
<div id="home">
  <section class="hero">
    <div class="particles" id="particles"></div>
    <h1>YesNo</h1>
    <p>ì˜ˆ, í˜¹ì€ ì•„ë‹ˆì˜¤.<br>ê·¸ê²ƒë§Œìœ¼ë¡œ ì§„ì‹¤ì— ë‹¿ì„ ìˆ˜ ìˆëŠ”ê°€?</p>
    <button class="hero-cta" onclick="scrollToStories()">ë¯¸ìŠ¤í„°ë¦¬ ì„ íƒí•˜ê¸°</button>
    <div class="scroll-hint">â†“</div>
  </section>

  <!-- Stats -->
  <section class="stats-section" id="stats-section">
    <h2 style="font-size:1.8rem;margin-bottom:1rem">ğŸ•µï¸ íƒì • ê¸°ë¡</h2>
    <div class="stats-card" id="stats-card"></div>
  </section>

  <section class="stories-section" id="stories-section">
    <h2>ğŸ“‚ ë¯¸ìŠ¤í„°ë¦¬ ëª©ë¡</h2>
    <p class="subtitle">í•˜ë‚˜ë¥¼ ê³¨ë¼ ì§„ì‹¤ì„ ë°í˜€ë¼</p>
    <p id="story-progress" style="color:var(--accent);font-size:.9rem;margin-bottom:1.5rem"></p>
    <div class="story-list" id="story-list"></div>
  </section>
</div>

<!-- GAME -->
<div class="game-screen" id="game-screen">
  <div class="game-header">
    <button class="game-back" onclick="goHome()" title="ë‚˜ê°€ê¸°">â†</button>
    <span class="game-title" id="game-title"></span>
    <span class="game-turns" id="game-turns">ì§ˆë¬¸ 0íšŒ</span>
  </div>
  <div class="chat-area" id="chat-area"></div>
  <div class="input-area" id="input-area">
    <input type="text" id="question-input" placeholder="ì˜ˆ/ì•„ë‹ˆì˜¤ë¡œ ë‹µí•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì„ í•˜ì„¸ìš”..." autocomplete="off">
    <button class="btn-ask" id="btn-ask" onclick="askQuestion()">ì§ˆë¬¸</button>
    <button class="btn-solve" onclick="openSolveModal()">ì •ë‹µ</button>
    <button class="btn-hint" id="btn-hint" onclick="requestHint()">ğŸ’¡ íŒíŠ¸ <span id="hint-count">3</span></button>
    <button class="btn-giveup" onclick="giveUp()">í¬ê¸°</button>
  </div>
</div>

<!-- SOLVE MODAL -->
<div class="modal-overlay" id="solve-modal">
  <div class="modal">
    <h3>ğŸ¯ ì •ë‹µ ì‹œë„</h3>
    <p style="color:var(--text2);margin-bottom:1rem;font-size:.9rem">ì „ì²´ ìŠ¤í† ë¦¬ë¥¼ ì„¤ëª…í•´ì£¼ì„¸ìš”. ì™œ ê·¸ëŸ° ìƒí™©ì´ ë²Œì–´ì§„ ê±´ì§€?</p>
    <textarea id="solve-input" placeholder="ì˜ˆ: ë‚¨ìëŠ” ì‚¬ì‹¤..."></textarea>
    <div class="modal-btns">
      <button class="modal-cancel" onclick="closeSolveModal()">ì·¨ì†Œ</button>
      <button class="modal-submit" onclick="submitSolve()">ì œì¶œí•˜ê¸°</button>
    </div>
  </div>
</div>

<!-- RESULT -->
<div class="result-screen" id="result-screen">
  <div class="result-emoji" id="result-emoji"></div>
  <h2 id="result-title"></h2>
  <div class="result-stats" id="result-stats"></div>
  <div class="result-answer" id="result-answer"></div>
  <div class="result-btns">
    <button class="btn-home" onclick="goHome()">ëª©ë¡ìœ¼ë¡œ</button>
    <button class="btn-share" onclick="shareResult()">ê³µìœ í•˜ê¸°</button>
  </div>
</div>

<script>
const API_BASE = 'https://yesno-api.harpy922.workers.dev';
let stories = [];
let currentStory = null;
let chatHistory = []; // {role, content} for Claude
let turnCount = 0;
let isLoading = false;
let startTime = 0;
let hintsUsed = 0;
let hintsLeft = 3;

// Storage helpers
function getCleared() {
  try { return JSON.parse(localStorage.getItem('yesno_cleared') || '[]'); } catch { return []; }
}
function setCleared(id) {
  const c = getCleared();
  if (!c.includes(id)) { c.push(id); localStorage.setItem('yesno_cleared', JSON.stringify(c)); }
}
function getStats() {
  try { return JSON.parse(localStorage.getItem('yesno_stats') || '{}'); } catch { return {}; }
}
function saveStat(storyId, data) {
  const stats = getStats();
  stats[storyId] = data;
  localStorage.setItem('yesno_stats', JSON.stringify(stats));
}
function getDetectiveGrade() {
  const cleared = getCleared().length;
  const stats = getStats();
  const avgQ = Object.values(stats).length > 0 
    ? Math.round(Object.values(stats).reduce((a, s) => a + (s.questions || 0), 0) / Object.values(stats).length) 
    : 0;
  if (cleared >= 15 && avgQ <= 10) return { grade: 'S', title: 'ğŸ§  ì…œë¡', color: '#00ff88' };
  if (cleared >= 10) return { grade: 'A', title: 'ğŸ© ëª…íƒì •', color: '#00ccff' };
  if (cleared >= 6) return { grade: 'B', title: 'ğŸ•µï¸ íƒì •', color: '#ffaa00' };
  if (cleared >= 3) return { grade: 'C', title: 'ğŸ” ìˆ˜ìŠµ íƒì •', color: '#ff6644' };
  return { grade: 'D', title: 'ğŸ£ ì´ˆë³´ íƒì •', color: '#888' };
}
function getGameGrade(questions, hints) {
  if (hints === 0 && questions <= 5) return 'S';
  if (hints === 0 && questions <= 10) return 'A';
  if (questions <= 15) return 'B';
  if (questions <= 25) return 'C';
  return 'D';
}

// Particles
function createParticles() {
  const container = document.getElementById('particles');
  for (let i = 0; i < 80; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDuration = (8 + Math.random() * 12) + 's';
    p.style.animationDelay = Math.random() * 10 + 's';
    const size = (2 + Math.random() * 4) + 'px';
    p.style.width = p.style.height = size;
    container.appendChild(p);
  }
}

function scrollToStories() {
  document.getElementById('stories-section').scrollIntoView({ behavior: 'smooth' });
}

// Load stories
async function loadStories() {
  try {
    const resp = await fetch(API_BASE + '/api/stories');
    const data = await resp.json();
    stories = data.stories;
  } catch (e) {
    // Fallback â€” will show error
    console.error('Failed to load stories:', e);
    stories = [];
  }
  renderStories();
}

function getUnlockedCount() {
  const cleared = getCleared().length;
  // First 4 open, then unlock 4 more per 3 clears
  if (cleared < 3) return 4;
  return Math.min(stories.length, 4 + Math.floor(cleared / 3) * 4);
}

function renderStories() {
  const list = document.getElementById('story-list');
  const cleared = getCleared();
  const unlocked = getUnlockedCount();
  
  // Sort: difficulty ascending for unlock order
  const sorted = [...stories].sort((a, b) => a.difficulty - b.difficulty);
  
  list.innerHTML = sorted.map((s, idx) => {
    const isCleared = cleared.includes(s.id);
    const isLocked = idx >= unlocked && !isCleared;
    const stars = Array.from({length: 3}, (_, i) =>
      `<span class="star ${i < s.difficulty ? '' : 'empty'}">${i < s.difficulty ? 'â˜…' : 'â˜†'}</span>`
    ).join('');
    
    if (isLocked) {
      return `
        <div class="story-card locked" data-id="${s.id}">
          <div class="card-header">
            <span class="card-emoji">ğŸ”’</span>
            <span class="card-title">???</span>
            <div class="card-diff">${stars}</div>
          </div>
          <p class="card-situation">ìŠ¤í† ë¦¬ë¥¼ ë” í´ë¦¬ì–´í•˜ë©´ í•´ê¸ˆë©ë‹ˆë‹¤</p>
          <div style="clear:both"></div>
        </div>
      `;
    }
    
    return `
      <div class="story-card ${isCleared ? 'cleared' : ''}" data-id="${s.id}">
        <div class="card-header">
          <span class="card-emoji">${s.emoji}</span>
          <span class="card-title">${s.title}</span>
          <div class="card-diff">${stars}</div>
        </div>
        <p class="card-situation">${s.situation}</p>
        ${isCleared ? '' : `<button class="card-start" onclick="startGame('${s.id}')">ì‹œì‘í•˜ê¸° â–¶</button>`}
        <div style="clear:both"></div>
      </div>
    `;
  }).join('');
  
  // Show progress
  const progress = document.getElementById('story-progress');
  if (progress) {
    progress.textContent = `ğŸ”“ ${Math.min(unlocked, stories.length)}/${stories.length} í•´ê¸ˆ Â· âœ… ${cleared.length} í´ë¦¬ì–´`;
  }
}

// Start Game
function startGame(storyId) {
  currentStory = stories.find(s => s.id === storyId);
  if (!currentStory) return;
  chatHistory = [];
  turnCount = 0;
  hintsUsed = 0;
  hintsLeft = 3;
  startTime = Date.now();

  document.getElementById('home').style.display = 'none';
  document.getElementById('result-screen').classList.remove('active');
  document.getElementById('game-screen').classList.add('active');
  document.getElementById('game-title').textContent = currentStory.emoji + ' ' + currentStory.title;
  document.getElementById('game-turns').textContent = 'ì§ˆë¬¸ 0íšŒ';

  const chat = document.getElementById('chat-area');
  chat.innerHTML = '';
  addChatMessage('ai', `${currentStory.situation}\n\në¬´ìŠ¨ ì¼ì´ ìˆì—ˆë˜ ê±¸ê¹Œ? ì˜ˆ/ì•„ë‹ˆì˜¤ë¡œ ë‹µí•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ì„ í•´ë³´ì„¸ìš”.`);

  document.getElementById('hint-count').textContent = '3';
  document.getElementById('btn-hint').disabled = false;
  document.getElementById('question-input').focus();
}

function addChatMessage(type, text, extraClass) {
  const chat = document.getElementById('chat-area');
  const div = document.createElement('div');
  div.className = `chat-msg ${type} ${extraClass || ''}`;
  if (type === 'ai') {
    div.innerHTML = `<div class="label">ğŸ¤– AI ì¶œì œì</div><div>${text.replace(/\n/g, '<br>')}</div>`;
  } else if (type === 'correct') {
    div.innerHTML = text;
  } else {
    div.innerHTML = text.replace(/\n/g, '<br>');
  }
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
  return div;
}

// Ask Question
async function askQuestion() {
  const input = document.getElementById('question-input');
  const q = input.value.trim();
  if (!q || isLoading) return;

  input.value = '';
  isLoading = true;
  document.getElementById('btn-ask').disabled = true;

  addChatMessage('user', q);
  chatHistory.push({ role: 'user', content: q });

  // Loading indicator
  const loadMsg = addChatMessage('ai', 'ìƒê° ì¤‘...<span class="loading"></span>');

  try {
    const resp = await fetch(API_BASE + '/api/ask', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ storyId: currentStory.id, chatHistory })
    });
    const data = await resp.json();

    loadMsg.remove();
    const answer = data.answer || data.error || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤';
    addChatMessage('ai', answer);
    chatHistory.push({ role: 'assistant', content: answer });

    turnCount++;
    document.getElementById('game-turns').textContent = `ì§ˆë¬¸ ${turnCount}íšŒ`;
  } catch (e) {
    loadMsg.remove();
    addChatMessage('system', 'âš ï¸ ì„œë²„ ì—°ê²° ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }

  isLoading = false;
  document.getElementById('btn-ask').disabled = false;
  input.focus();
}

// Hint
async function requestHint() {
  if (hintsLeft <= 0 || isLoading) return;
  isLoading = true;
  
  const loadMsg = addChatMessage('ai', 'íŒíŠ¸ ìƒê° ì¤‘...<span class="loading"></span>');
  
  try {
    const resp = await fetch(API_BASE + '/api/hint', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ storyId: currentStory.id, chatHistory })
    });
    const data = await resp.json();
    loadMsg.remove();
    
    const hint = data.hint || 'íŒíŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    addChatMessage('system', `ğŸ’¡ íŒíŠ¸: ${hint}`);
    chatHistory.push({ role: 'assistant', content: `[íŒíŠ¸] ${hint}` });
    
    hintsUsed++;
    hintsLeft--;
    document.getElementById('hint-count').textContent = hintsLeft;
    if (hintsLeft <= 0) {
      document.getElementById('btn-hint').disabled = true;
    }
  } catch (e) {
    loadMsg.remove();
    addChatMessage('system', 'âš ï¸ íŒíŠ¸ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
  isLoading = false;
}

// Solve
function openSolveModal() {
  document.getElementById('solve-modal').classList.add('active');
  document.getElementById('solve-input').value = '';
  document.getElementById('solve-input').focus();
}
function closeSolveModal() {
  document.getElementById('solve-modal').classList.remove('active');
}

async function submitSolve() {
  const attempt = document.getElementById('solve-input').value.trim();
  if (!attempt) return;
  closeSolveModal();

  isLoading = true;
  addChatMessage('user', `ğŸ¯ [ì •ë‹µ ì‹œë„] ${attempt}`);
  const loadMsg = addChatMessage('ai', 'íŒì • ì¤‘...<span class="loading"></span>');

  try {
    const resp = await fetch(API_BASE + '/api/solve', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ storyId: currentStory.id, attempt, chatHistory })
    });
    const data = await resp.json();
    loadMsg.remove();

    if (data.result === 'correct') {
      addChatMessage('correct', `<h3>ğŸ‰ ì •ë‹µ!</h3><p>${data.message}</p>`);
      setCleared(currentStory.id);
      setTimeout(() => showResult(true, data.fullAnswer || data.message), 2000);
    } else if (data.result === 'close') {
      addChatMessage('system', `ğŸ¤ ${data.message}`);
    } else {
      addChatMessage('system', `âŒ ${data.message}`);
    }
  } catch (e) {
    loadMsg.remove();
    addChatMessage('system', 'âš ï¸ ì„œë²„ ì—°ê²° ì˜¤ë¥˜. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
  }
  isLoading = false;
}

// Give Up
function giveUp() {
  if (!confirm('ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì •ë‹µì´ ê³µê°œë©ë‹ˆë‹¤.')) return;
  // We don't have the answer on frontend, so mark as cleared and show result
  setCleared(currentStory.id);
  showResult(false, null);
}

// Result
function showResult(solved, answer) {
  const elapsed = Math.round((Date.now() - startTime) / 1000);
  const min = Math.floor(elapsed / 60);
  const sec = elapsed % 60;
  const timeStr = `${min}ë¶„ ${sec}ì´ˆ`;
  const grade = solved ? getGameGrade(turnCount, hintsUsed) : '-';

  // Save stats
  if (solved) {
    saveStat(currentStory.id, {
      questions: turnCount,
      hints: hintsUsed,
      time: elapsed,
      grade: grade,
      date: new Date().toISOString()
    });
  }

  document.getElementById('game-screen').classList.remove('active');
  const rs = document.getElementById('result-screen');
  rs.classList.add('active');

  const gradeColors = { S: '#00ff88', A: '#00ccff', B: '#ffaa00', C: '#ff6644', '-': '#888' };

  document.getElementById('result-emoji').textContent = solved ? 'ğŸ‰' : 'ğŸ˜”';
  document.getElementById('result-title').textContent = solved ? 'ì‚¬ê±´ í•´ê²°!' : 'ë¯¸ì œ ì‚¬ê±´...';

  document.getElementById('result-stats').innerHTML = `
    <div class="stat-row"><span class="stat-label">ìŠ¤í† ë¦¬</span><span class="stat-value">${currentStory.emoji} ${currentStory.title}</span></div>
    <div class="stat-row"><span class="stat-label">ê²°ê³¼</span><span class="stat-value">${solved ? 'âœ… í•´ê²°' : 'âŒ í¬ê¸°'}</span></div>
    <div class="stat-row"><span class="stat-label">ë“±ê¸‰</span><span class="stat-value" style="color:${gradeColors[grade] || '#888'};font-size:1.5rem">${grade}</span></div>
    <div class="stat-row"><span class="stat-label">ì§ˆë¬¸ ìˆ˜</span><span class="stat-value">${turnCount}íšŒ</span></div>
    <div class="stat-row"><span class="stat-label">íŒíŠ¸ ì‚¬ìš©</span><span class="stat-value">${hintsUsed}íšŒ${hintsUsed === 0 ? ' ğŸ…' : ''}</span></div>
    <div class="stat-row"><span class="stat-label">ì†Œìš” ì‹œê°„</span><span class="stat-value">${timeStr}</span></div>
  `;

  // Store for share
  rs.dataset.shareData = JSON.stringify({ title: currentStory.title, questions: turnCount, time: timeStr, grade, hints: hintsUsed });

  const ra = document.getElementById('result-answer');
  if (answer) {
    ra.style.display = 'block';
    ra.innerHTML = `<h4>ğŸ’¡ ì •ë‹µ</h4><p>${answer}</p>`;
  } else {
    ra.style.display = 'block';
    ra.innerHTML = `<h4>ğŸ’¡ ì •ë‹µ</h4><p>ë‹¤ìŒì— ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!</p>`;
  }
}

// Share
function shareResult() {
  const rs = document.getElementById('result-screen');
  let d;
  try { d = JSON.parse(rs.dataset.shareData); } catch { d = {}; }
  
  const shareUrl = `https://yesno-api.harpy922.workers.dev/share/yesno?t=${encodeURIComponent(d.title||'')}&q=${d.questions||0}&s=${encodeURIComponent(d.time||'')}&g=${d.grade||'D'}&h=${d.hints||0}`;
  const text = `ğŸ”® YesNo â€” "${d.title}"\në“±ê¸‰ ${d.grade} Â· ì§ˆë¬¸ ${d.questions}íšŒ Â· ${d.time}${d.hints > 0 ? ' Â· íŒíŠ¸ ' + d.hints + 'íšŒ' : ''}\n\n${shareUrl}`;
  
  if (navigator.share) {
    navigator.share({ text, url: shareUrl });
  } else if (navigator.clipboard) {
    navigator.clipboard.writeText(text).then(() => alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!'));
  } else {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }
}

// Stats
function renderStats() {
  const cleared = getCleared();
  const stats = getStats();
  const det = getDetectiveGrade();
  const section = document.getElementById('stats-section');
  
  if (cleared.length === 0) {
    section.style.display = 'none';
    return;
  }
  section.style.display = 'block';
  
  const totalQ = Object.values(stats).reduce((a, s) => a + (s.questions || 0), 0);
  const totalTime = Object.values(stats).reduce((a, s) => a + (s.time || 0), 0);
  const avgQ = Object.values(stats).length > 0 ? Math.round(totalQ / Object.values(stats).length) : 0;
  const noHint = Object.values(stats).filter(s => s.hints === 0).length;
  const totalMin = Math.floor(totalTime / 60);
  
  document.getElementById('stats-card').innerHTML = `
    <div style="text-align:center;margin-bottom:1.5rem">
      <div class="grade-badge" style="color:${det.color}">${det.grade}</div>
      <div class="grade-title">${det.title}</div>
    </div>
    <div class="stats-grid">
      <div class="stat-box"><div class="stat-num">${cleared.length}</div><div class="stat-desc">í´ë¦¬ì–´</div></div>
      <div class="stat-box"><div class="stat-num">${avgQ}</div><div class="stat-desc">í‰ê·  ì§ˆë¬¸</div></div>
      <div class="stat-box"><div class="stat-num">${noHint}</div><div class="stat-desc">ë…¸íŒíŠ¸ ğŸ…</div></div>
      <div class="stat-box"><div class="stat-num">${totalMin}ë¶„</div><div class="stat-desc">ì´ í”Œë ˆì´</div></div>
    </div>
  `;
}

// Navigation
function goHome() {
  document.getElementById('game-screen').classList.remove('active');
  document.getElementById('result-screen').classList.remove('active');
  document.getElementById('home').style.display = 'block';
  window.scrollTo(0, 0);
  renderStories();
  renderStats();
}

// Enter key (handle Korean IME composition)
let isComposing = false;
document.addEventListener('compositionstart', () => { isComposing = true; });
document.addEventListener('compositionend', () => { isComposing = false; });
document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !isComposing && document.getElementById('game-screen').classList.contains('active')) {
    if (document.getElementById('solve-modal').classList.contains('active')) return;
    e.preventDefault();
    askQuestion();
  }
});

// Init
createParticles();
loadStories();
renderStats();
</script>
</body>
</html>
